<!DOCTYPE html>
<html lang="en" translate="no">

<head>
  <meta charset="utf-8" />
  <meta name="google" content="notranslate" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CLEAR.bed</title>

  <link rel="icon" type="image/png" href="assets/img/favicon_clearbed.png">
  <link rel="shortcut icon" href="assets/img/favicon_clearbed.png">

  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>

<body class="notranslate pushoff-mode compact-mode" translate="no">
  <input type="checkbox" class="hidden" id="debug_outline" />
  <div id="app_wrapper">
    <!-- Logo Section - Full Width -->
    <div id="app_logo">
      <img id="logo" src="assets/img/logo_swaplist_app.png" height="42" alt="swaplist logo" class="hidden">
      <img id="logo_pushoff" src="assets/img/logo_clearbed_app.png" height="42" alt="clearbed logo">
      <div id="swap_mode_logos" class="hidden">
        <img id="logo_jobox" src="assets/img/Jbox.png" height="42" alt="jobox logo" class="swap-logo active">
        <img id="logo_3print" src="assets/img/3Print.png" height="42" alt="3print logo" class="swap-logo inactive">
        <img id="logo_printflow" src="assets/img/printflowlogo.png" height="42" alt="printflow logo"
          class="swap-logo inactive">
      </div>
    </div>

    <div id="app_header" class="compact">
      <div>
        <div id="statistics" class="hidden">
          <div id="queue_statistics">
            <h3>Queue statistics:</h3>
            <div>
              <span> Duration: </span>
              <span id="total_time"> 19m 12s </span>
            </div>
            <div>
              <span> Plates: </span>
              <span id="used_plates"> 3 </span>
            </div>
          </div>
          <div id="filament_statistics">
            <h3>Filament usage statistics:</h3>
            <div id="filament_total">
              <div title="1">Slot 1: <br> 0.08m <br> 0.23g</div>
              <div title="2">Slot 2: <br> 0.08m <br> 0.23g</div>
              <div title="3">Slot 3: <br> 0.08m <br> 0.23g</div>
              <div title="4">Slot 4: <br> 0.08m <br> 0.23g</div>
            </div>
          </div>
        </div>
      </div>
      <div id="controls_box" class="hidden">
        <div id="mode_controls">
          <!-- App Mode Toggle -->
          <div id="app_mode_toggle" class="hidden">
            <label class="mode-switch">
              <input type="checkbox" id="mode_toggle_checkbox">
              <span class="mode-slider">
                <span class="mode-label mode-swap">SWAP Mode</span>
                <span class="mode-label mode-pushoff">Push Off Mode</span>
              </span>
            </label>
          </div>
          <!-- Printer Model Info -->
          <div id="printer_model_info" class="printer-info hidden">
            <span class="info-label">Printer Model:</span>
            <span id="current_printer_model" class="info-value">Unknown</span>
          </div>
        </div>
        <div id="action_buttons" class="hidden">
          <!-- Generate + Export Buttons -->
          <button id="export">Generate SWAP file</button>

          <button id="export_gcode">Export GCODE</button>

          <div id="progress_bar" style="opacity: 0; width: 100%;">
            <div id="progress_scale" style="width: 0%; display: flex;"> </div>
          </div>

          <!-- Reset Button -->
          <button id="reset">Reset</button>

        </div>
      </div>
    </div>

    <div id="app_content">

      <div id="plates_wrapper">
        <div id="drop_zones_wrapper">
          <div id="drop_zone" class="">
            <p>DROP YOUR FILE(S) HERE</p><i>...or click to select</i>
          </div>
        </div>
        <ol id="playlist_ol"></ol>
      </div>

      <!-- Settings Section: Below plates when loaded -->
      <div id="settings_panel" class="hidden">
        <div id="settings_content">
          <h3>Settings</h3>

          <!-- Loop Repeats - Top Level -->
          <div id="loop_repeats_section">
            <div class="settings-col">
              <input id="loops" autocomplete="off" type="number" min="1" max="9999" step="1" value="1">
              <label for="loops">Loop repeats</label>
              <details class="tool_info">
                <summary></summary>
                <p>This number defines how many times the entire
                  queue will be reprinted.</p>
                <p> Example: Plate "A"
                  is set to 3 repeats, plate "B" is set to 1
                  repeat and the "Loop repeats" is set to 2.
                  This will result in following printing order: </p>
                <p> A A A B A A A B .</p>
              </details>
            </div>
          </div>

          <!-- Plate Settings -->
          <div id="plate_settings_section">
            <h4>Plate Settings</h4>
            <p class="settings-instruction">Click on a plate above to configure its settings</p>

            <!-- Per-Plate Settings Container -->
            <div id="plate_specific_settings" class="hidden">
              <!-- Settings for selected plate will be shown here -->
            </div>
          </div>

          <!-- Global Settings -->
          <div id="global_settings_section">
            <h4>Global Settings</h4>

            <!-- Cooling Settings (Global) -->
            <div class="settings-group">
              <h4>Cooling & Bed Temperature</h4>
              <label id="bedlevel_cooling_container">
                <input type="checkbox" id="opt_bedlevel_cooling">
                Raise Bed Level for cooling
                <details class="tool_info">
                  <summary></summary>
                  <p>Activate this option to raise the bed to fan height for faster cooling. <b>Warning:</b> For large
                    prints the printer cover must be removed to avoid collision.</p>
                </details>
              </label>

              <div class="settings-row">
                <div class="settings-col">
                  <label for="cooldown_target_bed_temp">Cooldown target bed temperature (°C)</label>
                  <input id="cooldown_target_bed_temp" type="number" step="1" min="15" max="35" value="23">
                  <details class="tool_info">
                    <summary></summary>
                    <p>Specifies the bed temperature that should be reached before the push-out sequence.</p>
                  </details>
                </div>

                <div class="settings-col">
                  <label for="cooldown_max_time">Max cooldown time (min)</label>
                  <input id="cooldown_max_time" type="number" step="1" min="5" max="120" value="40">
                  <details class="tool_info">
                    <summary></summary>
                    <p>
                      Defines the maximum cooldown duration in minutes.
                      The app will insert repeated <code>M190</code> commands to wait for the bed
                      until this total time is reached. Default is 40 minutes.
                    </p>
                  </details>
                </div>
              </div>
            </div>

            <!-- Printer Sounds Settings (Global) -->
            <div class="settings-group printer-sounds-settings">
              <h4>Printer Sounds</h4>
              <label class="opt">
                <input type="checkbox" id="opt_disable_printer_sounds" checked>
                Disable printer sounds
                <details class="tool_info">
                  <summary></summary>
                  <p>
                    Controls printer sound removal for A1/A1M printers. When enabled, you can choose to
                    remove all sounds or only sounds between plates. This setting only affects A1/A1M printers.
                  </p>
                </details>
              </label>

              <div id="sound_removal_options" class="settings-row" style="margin-left: 20px;">
                <label>
                  <input type="radio" name="sound_removal_mode" id="sound_removal_all" value="all" checked>
                  Remove all printer sounds
                </label>
                <label>
                  <input type="radio" name="sound_removal_mode" id="sound_removal_between_plates"
                    value="between_plates">
                  Remove sounds only between plates
                </label>
              </div>
            </div>

            <!-- AMS Optimization Settings (Global) -->
            <div class="settings-group ams-optimization-settings">
              <h4>AMS Optimization</h4>
              <label class="opt">
                <input type="checkbox" id="opt_ams_optimization" checked>
                Enable AMS redundancy removal
                <details class="tool_info" id="opt_ams_optimization_help">
                  <summary></summary>
                  <p>
                    When <b>on</b>, the app automatically removes redundant AMS filament swaps
                    between plates. This eliminates unnecessary "unload all" + "load same slot"
                    sequences, making multi-plate prints more efficient. Only available for A1/A1M printers.
                  </p>
                </details>
              </label>
            </div>

            <!-- Startsequence Settings (Global) -->
            <div class="settings-group startsequence-settings">
              <h4>Startsequence</h4>
              <label class="opt">
                <input type="checkbox" id="opt_disable_bed_leveling">
                Disable bed leveling between plates
                <details class="tool_info">
                  <summary></summary>
                  <p>
                    When <b>on</b>, bed leveling is skipped for all plates after the first one.
                    This speeds up multi-plate printing by reusing the leveling data from the first plate.
                    Only available for X1/P1 printers in push-off mode.
                  </p>
                </details>
              </label>

              <label class="opt">
                <input type="checkbox" id="opt_disable_first_layer_scan">
                Disable first layer scan
                <details class="tool_info">
                  <summary></summary>
                  <p>
                    When <b>on</b>, the first layer inspection scan is disabled.
                    This can speed up the print start but removes the automatic quality check.
                    Only available for X1 printers in push-off mode.
                  </p>
                </details>
              </label>
            </div>

            <!-- Override Settings (Global) -->
            <div class="settings-group">
              <h4>Project Settings</h4>
              <label class="opt">
                <input type="checkbox" id="opt_override_metadata">
                Override project &amp; filament settings
                <details class="tool_info" id="opt_override_metadata_help">
                  <summary></summary>
                  <p>
                    When <b>on</b>, the app regenerates
                    the filament entries and material/printer settings. This is essential if you use new
                    AMS slot assignments that weren't present in the original G-code. When <b>off</b>,
                    the original 3MF metadata is kept as-is; if you remap to AMS slots that weren't
                    originally defined, the printer or Studio may report a mismatch.
                  </p>
                </details>
              </label>
            </div>

            <!-- Custom File Name Settings (Global) -->
            <div class="settings-group">
              <h4>File Settings</h4>
              <div class="settings-row">
                <div class="settings-col">
                  <label for="file_name">Custom file name:</label>
                  <input id="file_name" autocomplete="off" type="text" style="width: 18ch"
                    placeholder="output_file_name">
                  <span id="filename_extension_preview"> .swap.3mf</span>
                </div>
              </div>

              <label class="opt" id="test_file_export_container">
                <input type="checkbox" id="opt_test_file_export">
                Generate test file (start/end sequences only)
                <details class="tool_info">
                  <summary></summary>
                  <p>
                    When enabled, exports only the start and end sequences without the actual print code.
                    This creates a small test file perfect for verifying plate-swap logic, heating sequences,
                    and GCODE modifications without running a full print. The test file will go through all
                    plate changes but skip the actual object printing.
                  </p>
                </details>
              </label>

              <div class="settings-row" id="test_wait_time_container" style="display: none;">
                <div class="settings-col">
                  <label for="test_wait_time">Test file wait time (seconds):</label>
                  <input id="test_wait_time" type="number" min="0" max="200" value="30" style="width: 6ch">
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Templates for Per-Plate Settings -->
      <template id="plate_settings_template">
        <div class="plate-settings-content">
          <!-- Objects Settings (from plate template) -->
          <div class="settings-group">
            <h5>Objects on this plate</h5>
            <label class="obj-count-label">
              <span>Number of objects:</span>
              <select class="obj-count" autocomplete="off">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
              </select>
            </label>
            <div class="obj-coords"></div>
          </div>

          <!-- Nozzle and Filament Settings (Per-Plate) -->
          <div class="settings-group plate-nozzle-settings">
            <h5>Nozzle & Filament</h5>
            <label>
              <input type="checkbox" class="opt_purge_plate" autocomplete="off" checked />
              Hide nozzle load line in model
              <details class="tool_info">
                <summary></summary>
                <p>Activate this option to achieve the correct nozzle pressure when starting a new print. If
                  deactivated, this may cause slight under-extrusion at the bottom of the first object.</p>
              </details>
            </label>

            <label class="purge-off-wrapper" style="display: none;">
              <input type="checkbox" class="opt_filament_purge_off_plate">
              Turn off filament purge
              <details class="tool_info">
                <summary></summary>
                <p>Disable the filament purge sequence at the start of this plate.
                  This can speed up multi-plate jobs but might cause issues if the plate before used different
                  materials.</p>
              </details>
            </label>
          </div>

          <!-- Push-off Settings (Per-Plate) -->
          <div class="settings-group plate-pushoff-settings">
            <h5>Push-off & Ejection</h5>
            <label>Bed raise offset before push-out (mm)
              <input class="raisebed_offset_mm_plate" type="number" step="1" min="5" max="200" value="30">
              <details class="tool_info">
                <summary></summary>
                <p>Defines how much the bed is raised before performing the push-out sequence.</p>
              </details>
            </label>

            <div class="settings-separator"></div>

            <label>
              <input type="checkbox" class="opt_secure_pushoff_plate" checked>
              Secure push‑off sequence
              <details class="tool_info">
                <summary></summary>
                <p>
                  When enabled, the app performs multiple controlled push‑offs at decreasing Z heights
                  before the final push at Z=1. This helps avoid collisions and smooths the ejection.
                </p>
              </details>
            </label>

            <div class="settings-separator"></div>

            <div class="extra_pushoff_container_plate">
              <label class="extra_pushoff_levels_label_plate">
                Additional push‑off levels
                <input class="extra_pushoff_levels_plate" type="number" step="1" min="1" max="10" value="2">
              </label>
              <details class="tool_info">
                <summary></summary>
                <p>
                  Defines how the maximum Z height is divided. Example: if max Z is 100&nbsp;mm
                  and you enter <b>2</b>, push‑offs occur around Z≈50 and the final one at Z=1.
                  If you enter <b>5</b>, there will be 5 extra push‑offs, with the last always at Z=1.
                  A value of <b>1</b> means only a final push at Z=1.
                </p>
              </details>
            </div>
          </div>

        </div>
    </div>
    </template>
  </div>
  </div>

  <input type="file" autocomplete="off" accept=".3mf, .gcode" id="file" class="hidden" name="file" multiple />

  <template id="list_item_prototype">
    <li class="list_item hidden">
      <button class="plate-remove">×</button>
      <div class="p_title">
        <span class="f_id"> some_id </span>
        <span class="f_name single-line"> some_file.3mf </span>
        <span class="p_name"> some_plate </span> <br>
      </div>

      <img class="p_icon" />
      <div class="p_info" title="Duration of the plate printing and number of repeats.">
        <span class="p_time"> [plate_time] </span>
        <input class="p_rep" type="number" min="0" max="9999" step="1" value="1">
      </div>
      <div class="p_filaments">
        <div class="p_filament_prototype">
          <div class="f_color"> </div> <br>
          <span>Slot</span> <span class="f_slot"> </span> <br>
          <span class="f_type"> </span> <br>
          <span class="f_used_g"> </span> <span>g</span> <br>
          <span class="f_used_m"> </span> <span>m</span>
        </div>
      </div>
      <!-- Plate settings moved to settings panel -->
    </li>
  </template>

  <div id="site-info">

    <details id="app-info-container">
      <summary>App Information</summary>
      <div id="app-info-content">
        <div class="version-info">
          <p><strong>Clearbed Version V1.3</strong></p>
          <p>Inspired by Swaplist.app</p>
        </div>

        <details open>
          <summary>How to use this app</summary>
          <div class="usage-guide">
            <h3>Getting Started</h3>
            <ol>
              <li><strong>Load your files:</strong> Drag & drop your <code>.3mf</code> files (from Bambu Studio or Orca
                Slicer) or <code>.gcode</code> files into the drop zone above.</li>
              <li><strong>Printer detection:</strong> The app automatically detects your printer model and shows the
                corresponding mode (A1 Mini, X1, or P1).</li>
              <li><strong>Configure settings:</strong> Adjust options in the Settings panel that appears below your
                loaded plates.</li>
              <li><strong>Export:</strong> Click "Generate SWAP file" or "Export GCODE" to create your processed files.
              </li>
            </ol>

            <h3>Automatisation Mode</h3>
            <ul>
              <li><strong>A1 Mini (SWAP Mode):</strong> Creates .swap.3mf files for automatic plate swapping using
                Swaplist system</li>
              <li><strong>A1 (SWAP Mode):</strong> Supports 3Print and Printflow systems for automatic plate swapping
              </li>
              <li><strong>X1/P1 Series (Push-off Mode):</strong> Generates modified GCODE with automated push-off
                sequences</li>
            </ul>

            <h3>Working with Plates</h3>
            <ul>
              <li><strong>Select plates:</strong> Click on any plate to select it and configure plate-specific settings
              </li>
              <li><strong>Repeat count:</strong> Change the number next to each plate to print it multiple times</li>
              <li><strong>Remove plates:</strong> Click the "×" button in the top-right corner of any plate</li>
              <li><strong>Duplicate plates:</strong> Click the "+" button on the plate image to make a copy</li>
              <li><strong>Reorder plates:</strong> Drag plates to change the printing order</li>
            </ul>

            <h3>Filament & AMS Slots</h3>
            <ul>
              <li><strong>Change slot assignment:</strong> Click any colored filament swatch on a plate to reassign it
                to a different AMS slot (1-4)</li>
              <li><strong>Global slot colors:</strong> Click color swatches in "Filament usage statistics" to customize
                global slot colors</li>
              <li><strong>Usage tracking:</strong> View total filament consumption per slot in the statistics area</li>
            </ul>

            <h3>Settings Panel Options</h3>
            <h4>General Settings:</h4>
            <ul>
              <li><strong>Custom file name:</strong> Set your preferred output filename</li>
              <li><strong>Loop repeats:</strong> Number of times to repeat the entire print queue</li>
              <li><strong>Test file export:</strong> Generate a test file with only start/end sequences for debugging
              </li>
            </ul>

            <h4>Plate-Specific Settings:</h4>
            <p><em>Click on a plate above to access these settings:</em></p>
            <ul>
              <li><strong>Object count & coordinates:</strong> Configure number of objects on the plate and their X
                positions</li>
              <li><strong>Nozzle & filament settings:</strong> Control purge sequences and nozzle behavior per plate
              </li>
              <li><strong>Push-off settings:</strong> Customize ejection behavior for each individual plate</li>
            </ul>

            <h4>X1/P1 Advanced Options:</h4>
            <ul>
              <li><strong>"Turn off filament purge"</strong> - Skips purge sequence after first plate (faster
                multi-plate jobs). Only enable if there are no filament changes between plates.</li>
              <li><strong>"Hide nozzle load line in model"</strong> - Extrudes extra material at print start to
                compensate for the removed load line. Prevents under-extrusion on the object's bottom layer, but may be
                visible if print start is at the object's edge.</li>
              <li><strong>"Raise Bed Level for cooling"</strong> - Moves bed to fan height for faster cooling. For tall
                objects, remove the printer's top glass cover to prevent collisions.</li>
              <li><strong>"Secure push‑off sequence"</strong> - Uses controlled push-offs at multiple heights to
                guarantee safe ejection of finished objects from the printer</li>
              <li><strong>"Override project & filament settings"</strong> - Regenerates metadata for new slot
                assignments. This option becomes necessary when AMS slots are redefined.</li>
            </ul>

            <h4>Global Cooldown & Sound Settings:</h4>
            <ul>
              <li><strong>Target bed temperature:</strong> Cool down to this temperature before push-out (default: 23°C)
              </li>
              <li><strong>Max cooldown time:</strong> Maximum time to wait for cooling (default: 40 minutes)</li>
              <li><strong>Printer sounds:</strong> Disable all sounds or only sounds between plates (A1/A1M only)</li>
              <li><strong>AMS optimization:</strong> Remove redundant filament swaps between plates (A1/A1M only)</li>
            </ul>

          </div>
        </details>

        <details>
          <summary>Data security</summary>
          <p>
            This app uses your browser as an environment and runs locally on your computer.
            This means none of your data is sent to our server or any third party cloud provider.
            You can even save this app as a web page and use it completely offline.
            This site also does not use cookies or store any personal information on your device.
          </p>
        </details>
      </div>
    </details>
  </div>
  </div>

  <script src="dist/bundle.js"></script>
</body>

</html>